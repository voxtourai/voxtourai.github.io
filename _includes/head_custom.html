{% assign active_lang = site.active_lang | default: site.default_lang | default: "en" %}
{% assign default_lang = site.default_lang | default: active_lang %}
{% assign page_url = page.url | default: "/" %}

{% assign url_without_lang = page_url %}
{% if active_lang != default_lang %}
  {% assign lang_prefix = '/' | append: active_lang | append: '/' %}
  {% if page_url == '/' | append: active_lang %}
    {% assign url_without_lang = '/' %}
  {% elsif page_url == lang_prefix %}
    {% assign url_without_lang = '/' %}
  {% elsif page_url contains lang_prefix %}
    {% assign url_without_lang = page_url | replace_first: lang_prefix, '/' %}
  {% endif %}
{% endif %}

{% if site.languages and site.languages.size > 0 %}
  {% for lang in site.languages %}
    {% if lang == default_lang %}
      {% assign href = url_without_lang %}
    {% else %}
      {% assign href = '/' | append: lang | append: url_without_lang %}
    {% endif %}
    <link rel="alternate" hreflang="{{ lang }}" href="{{ href | absolute_url }}">
  {% endfor %}
  <link rel="alternate" hreflang="x-default" href="{{ url_without_lang | absolute_url }}">
{% endif %}

{% if page.robots %}
  <meta name="robots" content="{{ page.robots }}">
{% elsif page.noindex == true %}
  <meta name="robots" content="noindex, nofollow">
{% endif %}

{% if page.parent %}
  {% assign breadcrumb_items = "" %}
  {% assign position = 1 %}
  {% capture breadcrumb_items %}
{"@type":"ListItem","position":{{ position }},"name":"Home","item":"{{ '/' | absolute_url }}"}
  {% endcapture %}

  {% if page.grand_parent %}
    {% assign gp_title = page.grand_parent %}
    {% assign gp_page = site.pages | where: "title", gp_title | where: "lang", active_lang | first %}
    {% if gp_page == nil %}
      {% assign gp_page = site.pages | where: "title", gp_title | first %}
    {% endif %}
    {% if gp_page %}
      {% assign position = position | plus: 1 %}
      {% capture gp_item %}
{"@type":"ListItem","position":{{ position }},"name":"{{ gp_title | escape }}","item":"{{ gp_page.url | absolute_url }}"}
      {% endcapture %}
      {% assign breadcrumb_items = breadcrumb_items | append: "," | append: gp_item | strip %}
    {% endif %}
  {% endif %}

  {% assign parent_title = page.parent %}
  {% assign parent_page = site.pages | where: "title", parent_title | where: "lang", active_lang | first %}
  {% if parent_page == nil %}
    {% assign parent_page = site.pages | where: "title", parent_title | first %}
  {% endif %}
  {% if parent_page %}
    {% assign position = position | plus: 1 %}
    {% capture parent_item %}
{"@type":"ListItem","position":{{ position }},"name":"{{ parent_title | escape }}","item":"{{ parent_page.url | absolute_url }}"}
    {% endcapture %}
    {% assign breadcrumb_items = breadcrumb_items | append: "," | append: parent_item | strip %}
  {% endif %}

  {% assign position = position | plus: 1 %}
  {% capture current_item %}
{"@type":"ListItem","position":{{ position }},"name":"{{ page.title | escape }}","item":"{{ page.url | absolute_url }}"}
  {% endcapture %}
  {% assign breadcrumb_items = breadcrumb_items | append: "," | append: current_item | strip %}

  <script type="application/ld+json">
{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{{ breadcrumb_items }}]}
  </script>
{% endif %}

{% assign seo_image = nil %}
{% if page.seo and page.seo.image %}
  {% assign seo_image = page.seo.image %}
{% endif %}
{% if page.header_image and page.image == nil and seo_image == nil %}
  <meta property="og:image" content="{{ page.header_image | absolute_url }}">
  <meta name="twitter:image" content="{{ page.header_image | absolute_url }}">
  <meta name="twitter:card" content="summary_large_image">
{% endif %}
